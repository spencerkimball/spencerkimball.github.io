<!DOCTYPE html>
<meta charset="utf-8">

<title>
  Read-Only Critital Path Analysis
</title>

<body>
  <h2>Critital Path, Batch=1, Batch=10</h2>
  <svg id="batch1" width="960" height="600"></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://unpkg.com/d3-sankey"></script>
  <script>

var batch1 = {
  "nodes": [
    {"name":"1x Batched Read-only (storage + dist opts)"},
    {"name":"Replica overhead","overhead":14},
    {"name":"Store.Send"},
    {"name":"Dist KV overhead","overhead":36},
    {"name":"Dist KV"},
    {"name":"PGWire + SQL overhead","overhead":76},
    {"name":"KV Loadgen"},

    {"name":"10x Batched Read-only (storage + dist opts)"},
    {"name":"Replica overhead","overhead":5},
    {"name":"Store.Send"},
    {"name":"Dist KV overhead","overhead":20},
    {"name":"Dist KV"},
    {"name":"PGWire + SQL overhead","overhead":64},
    {"name":"KV Loadgen"},
  ],
  "links": [
    {"source":0,"target":1,"value":220000},
    {"source":0,"target":2,"value":1310000},
    {"source":2,"target":3,"value":470000},
    {"source":2,"target":4,"value":840000},
    {"source":4,"target":5,"value":640000},
    {"source":4,"target":6,"value":200000},

    {"source":7,"target":8,"value":200000},
    {"source":7,"target":9,"value":3800000},
    {"source":9,"target":10,"value":750000},
    {"source":9,"target":11,"value":3050000},
    {"source":11,"target":12,"value":1950000},
    {"source":11,"target":13,"value":1100000},
  ]};

showSankey(batch1, d3.select("#batch1"));

function showSankey(batchData, svg) {
  var width = svg.attr("width"),
      height = svg.attr("height");

  var formatNumber = d3.format(",.0f"),
      format = function(d) { return formatNumber(d) + " selects / second"; },
      color = d3.scaleOrdinal(d3.schemeCategory10);

  var sankey = d3.sankey()
      .nodeWidth(15)
      .nodePadding(10)
      .nodeAlign(d3.sankeyLeft)
      .extent([[1, 1], [width - 1, height - 6]]);

  var link = svg.append("g")
      .attr("class", "links")
      .attr("fill", "none")
      .attr("stroke", "#000")
      .attr("stroke-opacity", 0.2)
      .selectAll("path");

  var node = svg.append("g")
      .attr("class", "nodes")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .selectAll("g");

  sankey(batchData);

  link = link
    .data(batchData.links)
    .enter().append("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke-width", function(d) { return Math.max(1, d.width); });

  link.append("title")
    .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

  node = node
    .data(batchData.nodes)
    .enter().append("g");

  node.append("rect")
    .attr("x", function(d) { return d.x0; })
    .attr("y", function(d) { return d.y0; })
    .attr("height", function(d) { return d.y1 - d.y0; })
    .attr("width", function(d) { return d.x1 - d.x0; })
    .attr("fill", function(d) { return color(d.name.replace(/ .*/, "")); })
    .attr("stroke", "#000");

  node.append("text")
    .attr("x", function(d) { return d.x0 - 6; })
    .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
    .attr("dy", "0.35em")
    .attr("text-anchor", "end")
    .text(function(d) { return d.name; })
    .filter(function(d) { return d.x0 < width / 2; })
    .attr("x", function(d) { return d.x1 + 6; })
    .attr("text-anchor", "start");
  node.append("text")
    .attr("x", function(d) { return d.x0 - 6; })
    .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
    .attr("dy", "1.35em")
    .attr("text-anchor", "end")
    .text(function(d) { return d.overhead ? "(-" + d.overhead + "%)" : ""; })
    .filter(function(d) { return d.x0 < width / 2; })
    .attr("x", function(d) { return d.x1 + 6; })
    .attr("text-anchor", "start");

  node.append("title")
    .text(function(d) { return d.name + "\n" + format(d.value); });
}

  </script>
</body>
