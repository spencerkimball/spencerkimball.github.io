<!DOCTYPE html>
<meta charset="utf-8">

<body>
  <h2>Critital Path, Batch=1</h2>
  <svg id="batch1" width="960" height="300"></svg>
  <h2>Critital Path, Batch=10</h2>
  <svg id="batch10" width="960" height="300"></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://unpkg.com/d3-sankey"></script>
  <script>

var batch1 = {
  "nodes": [
    {"name":"Read-only batch execute"},
    {"name":"Replica overhead (CmdQ, TSCache)","overhead":31},
    {"name":"Store.Send"},
    {"name":"KV overhead (range cache, iter)","overhead":22},
    {"name":"DistSender Local"},
    {"name":"Dist KV + gRPC overhead","overhead":71},
    {"name":"DistSender.Send"},
    {"name":"PGWire + SQL overhead","overhead":13},
    {"name":"KV Loadgen"},
  ],
  "links": [
    {"source":0,"target":1,"value":395000},
    {"source":0,"target":2,"value":875000},
    {"source":2,"target":3,"value":195000},
    {"source":2,"target":4,"value":680000},
    {"source":4,"target":5,"value":485000},
    {"source":4,"target":6,"value":195000},
    {"source":6,"target":7,"value":25000},
    {"source":6,"target":8,"value":170000}
  ]};

var batch10 = {
  "nodes": [
    {"name":"Read-only batch execute"},
    {"name":"Replica overhead (CmdQ, TSCache)","overhead":1},
    {"name":"Store.Send"},
    {"name":"KV overhead (range cache, iter)","overhead":38},
    {"name":"DistSender Local"},
    {"name":"Dist KV + gRPC overhead","overhead":51},
    {"name":"DistSender.Send"},
    {"name":"PGWire + SQL overhead","overhead":11},
    {"name":"KV Loadgen"},
  ],
  "links": [
    {"source":0,"target":1,"value":25000},
    {"source":0,"target":2,"value":3700000},
    {"source":2,"target":3,"value":1400000},
    {"source":2,"target":4,"value":2300000},
    {"source":4,"target":5,"value":1175000},
    {"source":4,"target":6,"value":1125000},
    {"source":6,"target":7,"value":125000},
    {"source":6,"target":8,"value":1000000}
  ]};

showSankey(batch1, d3.select("#batch1"));
showSankey(batch10, d3.select("#batch10"));

function showSankey(batchData, svg) {
  var width = svg.attr("width"),
      height = svg.attr("height");

  var formatNumber = d3.format(",.0f"),
      format = function(d) { return formatNumber(d) + " selects / second"; },
      color = d3.scaleOrdinal(d3.schemeCategory10);

  var sankey = d3.sankey()
      .nodeWidth(15)
      .nodePadding(10)
      .nodeAlign(d3.sankeyLeft)
      .extent([[1, 1], [width - 1, height - 6]]);

  var link = svg.append("g")
      .attr("class", "links")
      .attr("fill", "none")
      .attr("stroke", "#000")
      .attr("stroke-opacity", 0.2)
      .selectAll("path");

  var node = svg.append("g")
      .attr("class", "nodes")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .selectAll("g");

  sankey(batchData);

  link = link
    .data(batchData.links)
    .enter().append("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke-width", function(d) { return Math.max(1, d.width); });

  link.append("title")
    .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

  node = node
    .data(batchData.nodes)
    .enter().append("g");

  node.append("rect")
    .attr("x", function(d) { return d.x0; })
    .attr("y", function(d) { return d.y0; })
    .attr("height", function(d) { return d.y1 - d.y0; })
    .attr("width", function(d) { return d.x1 - d.x0; })
    .attr("fill", function(d) { return color(d.name.replace(/ .*/, "")); })
    .attr("stroke", "#000");

  node.append("text")
    .attr("x", function(d) { return d.x0 - 6; })
    .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
    .attr("dy", "0.35em")
    .attr("text-anchor", "end")
    .text(function(d) { return d.name; })
    .filter(function(d) { return d.x0 < width / 2; })
    .attr("x", function(d) { return d.x1 + 6; })
    .attr("text-anchor", "start");
  node.append("text")
    .attr("x", function(d) { return d.x0 - 6; })
    .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
    .attr("dy", "1.35em")
    .attr("text-anchor", "end")
    .text(function(d) { return d.overhead ? "(-" + d.overhead + "%)" : ""; })
    .filter(function(d) { return d.x0 < width / 2; })
    .attr("x", function(d) { return d.x1 + 6; })
    .attr("text-anchor", "start");

  node.append("title")
    .text(function(d) { return d.name + "\n" + format(d.value); });
}

  </script>
</body>
